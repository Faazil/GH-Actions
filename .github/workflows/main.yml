name: Deploy Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: '1test'

jobs:
  validate-and-trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Validate Environment Input
        id: validate
        run: |
          VALID_ENVIRONMENTS=("1eng" "1test" "1prod" "1loc")
          INPUT_ENVIRONMENT="${{ github.event.inputs.environment }}"
          if [[ " ${VALID_ENVIRONMENTS[@]} " =~ " ${INPUT_ENVIRONMENT} " ]]; then
            echo "Environment input is valid: ${INPUT_ENVIRONMENT}"
            echo "::set-output name=environment::${INPUT_ENVIRONMENT}"
          else
            echo "Invalid environment input: ${INPUT_ENVIRONMENT}"
            exit 1
          fi

      - name: Trigger Common Repository Workflow
        if: steps.validate.outputs.environment
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.everest-preview+json" \
            -H "Content-Type: application/json" \
            -d '{"event_type": "deploy-environment", "client_payload": {"environment": "${{ steps.validate.outputs.environment }}"}}' \
            https://api.github.com/repos/Faazil/common/dispatches
