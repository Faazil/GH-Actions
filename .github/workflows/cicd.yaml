name: CICD Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        default: '1loc'

jobs:
  validate-and-deploy:
    runs-on: rhel999
    outputs:
      AEM_HOST: ${{ steps.extract_url.outputs.AEM_AUTHOR_URL }}
      AEM_PREVIEW_URL: ${{ steps.extract_url.outputs.AEM_PREVIEW_URL }}
      AEM_CREDENTIALS: ${{ steps.set-credentials.outputs.AEM_CREDENTIALS }}
      AEM_PACKAGE_NAME: ${{ steps.set-package-name.outputs.AEM_PACKAGE_NAME }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate Environment Input
        id: validate
        run: |
          VALID_ENVIRONMENTS=$(awk '/awsAccounts:/{flag=1;next}/type/{flag=0}flag' .github/environments.yaml | sed 's/- //g' | tr '\n' ' ' | tr '[:upper:]' '[:lower:]')
          
          INPUT_ENVIRONMENT=$(echo "${{ github.event.inputs.environment }}" | tr '[:upper:]' '[:lower:]')
       
          VALID_ENVIRONMENTS_ARRAY=($VALID_ENVIRONMENTS)
          
          if [[ " ${VALID_ENVIRONMENTS_ARRAY[@]} " =~ " ${INPUT_ENVIRONMENT} " ]]; then
            echo "Environment input is valid: ${INPUT_ENVIRONMENT}"
            echo "environment=${INPUT_ENVIRONMENT}" >> $GITHUB_OUTPUT
          else
            echo "Invalid environment input: ${INPUT_ENVIRONMENT}"
            exit 1
          fi

      - name: Ensure env_urls.yaml is available
        run: |
          if [ ! -f .github/env_urls.yaml ]; then
            echo "env_urls.yaml not found in the repository."
            exit 1
          fi

      - name: Extract Environment URL
        id: extract_url
        run: |
          environment=$(echo "${{ steps.validate.outputs.environment }}" | tr '[:upper:]' '[:lower:]')
          echo "Extracting URL for environment: $environment" # Debugging step

          if [[ "$environment" == *"prod-live"* ]]; then
            author_url=$(awk -F": " '/ess-prod:/{print $2}' .github/env_urls.yaml)
            preview_url=""
            echo "Prod-live environment detected, Author URL: $author_url, No Preview URL" # Debugging step
            echo "AEM_AUTHOR_URL=$author_url" >> $GITHUB_ENV
            echo "AEM_PREVIEW_URL=$preview_url" >> $GITHUB_ENV
            echo "::set-output name=AEM_AUTHOR_URL::$author_url"
            echo "::set-output name=AEM_PREVIEW_URL::$preview_url"
          elif [[ "$environment" == *"prod"* ]] && [[ "$environment" != *"live"* ]]; then
            author_url=$(awk -F": " '/ess-prod:/{print $2}' .github/env_urls.yaml)
            preview_url=$(awk -F": " '/ess-prod-preview:/{print $2}' .github/env_urls.yaml)
            echo "Prod environment detected, Author URL: $author_url, Preview URL: $preview_url" # Debugging step
            echo "AEM_AUTHOR_URL=$author_url" >> $GITHUB_ENV
            echo "AEM_PREVIEW_URL=$preview_url" >> $GITHUB_ENV
            echo "::set-output name=AEM_AUTHOR_URL::$author_url"
            echo "::set-output name=AEM_PREVIEW_URL::$preview_url"
          else
            url=$(awk -v env="$environment" 'BEGIN {FS=": "; OFS=": "} {if(tolower($1) == tolower(env)) {gsub(/^ *| *$/, "", $2); print $2}}' .github/env_urls.yaml)
            author_url=$url
            preview_url=""
            echo "General environment detected, URL: $url" # Debugging step
            if [ -z "$url" ]; then
              echo "Invalid environment: $environment"
              exit 1
            fi
            echo "AEM_AUTHOR_URL=$author_url" >> $GITHUB_ENV
            echo "AEM_PREVIEW_URL=$preview_url" >> $GITHUB_ENV
            echo "::set-output name=AEM_AUTHOR_URL::$author_url"
            echo "::set-output name=AEM_PREVIEW_URL::$preview_url"
          fi

      - name: Set AEM Credentials
        id: set-credentials
        run: echo "::set-output name=AEM_CREDENTIALS::${{ secrets.AEM_CREDENTIALS }}"

      - name: Set AEM Package Name
        id: set-package-name
        run: echo "::set-output name=AEM_PACKAGE_NAME::we.retail.community.apps-1.11.84.zip"

      - name: Check variables
        run: |
          echo "AEM_AUTHOR_URL: $AEM_AUTHOR_URL"
          echo "AEM_PREVIEW_URL: $AEM_PREVIEW_URL"

      - name: Upload package artifact
        uses: actions/upload-artifact@v2
        with:
          name: package
          path: we.retail.community.apps-1.11.84.zip

  upload-aem-package:
    needs: validate-and-deploy
    uses: Faazil/Common/.github/workflows/deployment.yaml@main  # Assuming this points to your reusable workflow location
    with:
      AEM_CREDENTIALS: ${{ needs.validate-and-deploy.outputs.AEM_CREDENTIALS }}
      AEM_PACKAGE_NAME: ${{ needs.validate-and-deploy.outputs.AEM_PACKAGE_NAME }}
      AEM_HOST: ${{ needs.validate-and-deploy.outputs.AEM_AUTHOR_URL }}
      AEM_PREVIEW_URL: ${{ needs.validate-and-deploy.outputs.AEM_PREVIEW_URL }}
